<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#040a04">
<title>Mundo Musgo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400;1,600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BITNIKGAMES DESIGN SYSTEM â€” Mundo Musgo Theme
   dark Â· orgÃ¢nico Â· bioluminescente Â· vegetal
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* LAYER 0 â€” Reset */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; font-size: 125%; }
body {
  font-family: var(--font-body);
  background: var(--bg-screen);
  color: var(--text-primary);
  min-height: 100dvh;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}
button { cursor: pointer; font-family: var(--font-body); }
textarea, input { font-family: var(--font-body); }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-screen); }
::-webkit-scrollbar-thumb { background: var(--bg-border); border-radius: 3px; border: 1px solid var(--bg-screen); }

/* LAYER 1 â€” Tokens : Mundo Musgo */
:root {
  --bg-abyss:   #c8eae3;
  --bg-screen:  #d8f0ea;
  --bg-panel:   #e4f6f2;
  --bg-raised:  #f0faf8;
  --bg-border:  #9dcec5;

  --text-primary:   #0a3328;
  --text-secondary: #2a6e5a;
  --text-inverse:   #f0faf8;

  --accent:   #0d6e52;
  --confirm:  #1a9e6f;
  --warning:  #8a5c00;
  --danger:   #b52a2a;
  --gm-color: #0d6e52;

  --player-0: #0a2118;
  --player-1: #1a5fa8;
  --player-2: #8a5c00;
  --player-3: #b52a2a;
  --player-4: #6b35a8;
  --player-5: #2a6e8a;

  --font-display: 'Cinzel Decorative', serif;
  --font-body:    'Playfair Display', Georgia, serif;
  --font-mono:    'JetBrains Mono', monospace;

  --text-xs:   0.7rem;
  --text-sm:   0.85rem;
  --text-base: 1rem;
  --text-lg:   1.1rem;
  --text-xl:   1.35rem;
  --text-2xl:  1.7rem;

  --sp-1: 0.25rem; --sp-2: 0.5rem; --sp-3: 0.75rem;
  --sp-4: 1rem;    --sp-5: 1.25rem; --sp-6: 1.5rem;
  --sp-8: 2rem;

  --radius-sm: 5px; --radius-md: 9px; --radius-lg: 14px;
  --shadow-md: 0 4px 12px rgba(0,0,0,.7);
  --shadow-accent: 0 0 18px rgba(13,110,82,.25);

  --dur-fast: 120ms; --dur-base: 220ms;
  --ease-out: cubic-bezier(0.16,1,0.3,1);
}

/* LAYER 2 â€” Components */
.screen { display: none; flex-direction: column; min-height: 100dvh; }
.screen.active { display: flex; }

.bg-btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: var(--sp-2); padding: var(--sp-2) var(--sp-5);
  border: none; border-radius: var(--radius-md);
  font-size: var(--text-sm); font-weight: 600; font-family: var(--font-body);
  cursor: pointer; user-select: none;
  transition: transform var(--dur-fast) var(--ease-out),
              box-shadow var(--dur-base) var(--ease-out);
}
.bg-btn:active { transform: scale(0.95); }
.bg-btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }

.bg-btn-primary {
  background: var(--accent); color: var(--text-inverse);
  box-shadow: var(--shadow-accent);
}
.bg-btn-primary:hover:not(:disabled) {
  box-shadow: 0 0 28px rgba(13,110,82,.4); transform: translateY(-1px);
}
.bg-btn-secondary {
  background: var(--bg-raised); color: var(--text-primary);
  border: 1px solid var(--bg-border);
}
.bg-btn-secondary:hover:not(:disabled) { background: var(--bg-border); }
.bg-btn-ghost {
  background: transparent; color: var(--text-secondary);
  border: 1px solid var(--bg-border);
  padding: var(--sp-1) var(--sp-3); font-size: var(--text-xs);
}
.bg-btn-ghost:hover:not(:disabled) { color: var(--text-primary); border-color: var(--text-secondary); }
.bg-btn-danger {
  background: transparent; color: var(--danger);
  border: 1px solid rgba(248,113,113,.35);
  padding: var(--sp-1) var(--sp-3); font-size: var(--text-xs);
}
.bg-btn-danger:hover:not(:disabled) { background: rgba(248,113,113,.1); }
.bg-btn-warn {
  background: var(--warning); color: var(--text-inverse);
}

.bg-panel {
  background: var(--bg-panel); border: 1px solid var(--bg-border);
  border-radius: var(--radius-lg); padding: var(--sp-3);
  box-shadow: var(--shadow-md);
}
.bg-panel-raised {
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-md); padding: var(--sp-3);
}

.bg-chip {
  display: inline-flex; align-items: center; gap: var(--sp-1);
  padding: 2px var(--sp-2);
  background: color-mix(in srgb, var(--chip-color,#5aff6e) 15%, transparent);
  border: 1px solid color-mix(in srgb, var(--chip-color,#5aff6e) 40%, transparent);
  border-radius: var(--radius-full, 999px);
  color: var(--chip-color, #5aff6e);
  font-size: var(--text-xs); font-family: var(--font-mono);
  white-space: nowrap;
}
.bg-chip.offline { opacity: 0.4; text-decoration: line-through; }
.bg-chip.gm::before { content:'â¬¡ '; }

.bg-input {
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-sm); color: var(--text-primary);
  padding: var(--sp-2) var(--sp-3); font-size: var(--text-sm);
  width: 100%; outline: none;
  transition: border-color var(--dur-fast);
}
.bg-input:focus { border-color: var(--accent); }

.bg-textarea {
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-sm); color: var(--text-primary);
  padding: var(--sp-2) var(--sp-3); font-size: var(--text-sm);
  width: 100%; outline: none; resize: vertical; line-height: 1.5;
  transition: border-color var(--dur-fast);
}
.bg-textarea:focus { border-color: var(--accent); }

.bg-label {
  display: block; font-family: var(--font-mono);
  font-size: var(--text-xs); color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: .05em;
  margin-bottom: var(--sp-1);
}

/* Banner */
.bg-banner {
  position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) translateY(-80px);
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  color: var(--text-primary); padding: var(--sp-2) var(--sp-6);
  border-radius: var(--radius-full, 999px); font-size: var(--text-sm);
  box-shadow: var(--shadow-md); z-index: 9999;
  transition: transform var(--dur-base) var(--ease-out);
  white-space: nowrap;
}
.bg-banner.show { transform: translateX(-50%) translateY(0); }
.bg-banner.confirm { border-color: var(--confirm); color: var(--confirm); }
.bg-banner.danger  { border-color: var(--danger);  color: var(--danger); }
.bg-banner.warning { border-color: var(--warning); color: var(--warning); }

/* Modal */
.bg-modal-overlay {
  position: fixed; inset: 0; background: rgba(2,6,2,.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; backdrop-filter: blur(4px);
}
.bg-modal-overlay.hidden { display: none; }
.bg-modal-box {
  background: var(--bg-panel); border: 1px solid var(--bg-border);
  border-radius: var(--radius-lg); padding: var(--sp-6);
  width: min(700px, 95vw); max-height: 90vh;
  overflow-y: auto; box-shadow: var(--shadow-md);
}
.bg-modal-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: var(--sp-4);
}
.bg-modal-title {
  font-family: var(--font-display); font-size: var(--text-xl);
  color: var(--accent);
}

/* Topbar */
.bg-topbar {
  background: var(--bg-abyss); border-bottom: 1px solid var(--bg-border);
  padding: var(--sp-2) var(--sp-4);
  display: flex; align-items: center; gap: var(--sp-3);
  position: sticky; top: 0; z-index: 100;
}
.bg-topbar-title {
  font-family: var(--font-display); font-size: var(--text-lg);
  color: var(--accent); flex: 1;
}

/* Animations */
@keyframes fade-in  { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }
@keyframes glow-pulse { 0%,100% { box-shadow: var(--shadow-accent); } 50% { box-shadow: 0 0 28px rgba(90,255,110,.5); } }
@keyframes dice-roll { 0% { transform:rotate(0deg) scale(1.2); } 100% { transform:rotate(360deg) scale(1); } }

.anim-fade-in  { animation: fade-in var(--dur-base) var(--ease-out) both; }
.anim-glow     { animation: glow-pulse 2s ease-in-out infinite; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: NAME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-name {
  align-items: center; justify-content: center;
  background: radial-gradient(ellipse at center, #b8e4dc 0%, var(--bg-screen) 70%);
}
.name-card {
  text-align: center; width: min(400px,90vw);
  padding: var(--sp-8);
}
.name-title {
  font-family: var(--font-display); font-size: var(--text-2xl);
  color: var(--accent); margin-bottom: var(--sp-2);
  text-shadow: 0 0 20px rgba(13,110,82,.3);
}
.name-sub {
  color: var(--text-secondary); font-style: italic;
  font-size: var(--text-sm); margin-bottom: var(--sp-6);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: LOBBY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-lobby { background: var(--bg-screen); }
.lobby-header {
  text-align: center; padding: var(--sp-8) var(--sp-4) var(--sp-4);
}
.lobby-title {
  font-family: var(--font-display); font-size: var(--text-xl);
  color: var(--accent); margin-bottom: var(--sp-2);
}
.lobby-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
  gap: var(--sp-4); padding: var(--sp-4) var(--sp-6) var(--sp-8);
  max-width: 900px; margin: 0 auto;
}
.mesa-card {
  background: var(--bg-panel); border: 1px solid var(--bg-border);
  border-radius: var(--radius-lg); padding: var(--sp-4);
  display: flex; flex-direction: column; gap: var(--sp-3);
  transition: border-color var(--dur-base);
}
.mesa-card:hover { border-color: color-mix(in srgb, var(--accent) 40%, transparent); }
.mesa-card-name { font-family: var(--font-display); font-size: var(--text-base); color: var(--text-primary); }
.mesa-card-status { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-secondary); }
.mesa-card-players { display: flex; flex-wrap: wrap; gap: var(--sp-1); min-height: 28px; }
.mesa-card-gm { font-size: var(--text-xs); color: var(--warning); font-style: italic; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN: GAME  â€” shared wrapper
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-game { background: var(--bg-screen); overflow: hidden; }

/* â”€â”€ GM LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gm-layout {
  display: grid;
  grid-template-rows: auto 1fr;
  height: 100dvh; overflow: hidden;
}
.gm-body {
  display: grid;
  grid-template-columns: 320px 1fr 280px;
  gap: 1px; background: var(--bg-border);
  overflow: hidden;
}
.gm-left, .gm-center, .gm-right {
  background: var(--bg-screen); overflow-y: auto;
  padding: var(--sp-3);
  display: flex; flex-direction: column; gap: var(--sp-3);
}

/* â”€â”€ PLAYER LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.player-layout {
  display: grid;
  grid-template-rows: auto auto auto 1fr;
  height: 100dvh; overflow: hidden;
}
.scene-area {
  background: var(--bg-abyss); border-bottom: 1px solid var(--bg-border);
  padding: var(--sp-4); min-height: 70px; max-height: 200px; overflow-y: auto;
}
.scene-text-display {
  font-size: var(--text-base); color: var(--text-primary);
  line-height: 1.7; font-style: italic;
  white-space: pre-wrap;
}
.scene-text-display.empty { color: var(--text-secondary); font-size: var(--text-sm); }

.media-area {
  border-bottom: 1px solid var(--bg-border);
  max-height: 250px; overflow: hidden;
}
.media-area img { width: 100%; max-height: 250px; object-fit: contain; background: var(--bg-abyss); }
.media-area iframe { width: 100%; height: 250px; border: none; }
.media-area.empty { display: none; }

.player-mid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap: var(--sp-2); padding: var(--sp-2);
  overflow-x: auto; max-height: 160px;
  background: var(--bg-panel); border-bottom: 1px solid var(--bg-border);
}

.player-bottom {
  display: grid;
  grid-template-columns: 220px 1fr 240px;
  gap: 1px; background: var(--bg-border);
  overflow: hidden;
}
.player-bottom > div {
  background: var(--bg-screen); overflow-y: auto;
  padding: var(--sp-3);
  display: flex; flex-direction: column; gap: var(--sp-2);
}

/* â”€â”€ PLAYER CARD (mini, shown to others) â”€ */
.player-card {
  background: var(--bg-panel); border: 1px solid var(--bg-border);
  border-radius: var(--radius-md); padding: var(--sp-2);
  display: flex; flex-direction: column; gap: var(--sp-1);
  min-width: 160px;
}
.player-card.is-gm { border-color: var(--accent); }
.player-card-name {
  font-family: var(--font-mono); font-size: var(--text-xs);
  font-weight: 600;
}
.player-card-stats {
  font-family: var(--font-mono); font-size: var(--text-xs);
  color: var(--text-secondary);
  display: flex; gap: var(--sp-2); flex-wrap: wrap;
}
.player-card-musgo { letter-spacing: 2px; }
.player-card-action {
  font-size: var(--text-xs); color: var(--text-secondary);
  font-style: italic; line-height: 1.3;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.player-card-dice {
  font-family: var(--font-mono); font-size: var(--text-xs);
  color: var(--warning); background: var(--bg-raised);
  border-radius: var(--radius-sm); padding: 2px var(--sp-2);
}
.player-card-dice .die-face { font-size: 1em; }

/* â”€â”€ DICE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dice-panel { display: flex; flex-direction: column; gap: var(--sp-2); }
.dice-buttons { display: flex; flex-wrap: wrap; gap: var(--sp-1); }
.dice-btn {
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-sm); color: var(--text-primary);
  font-family: var(--font-mono); font-size: var(--text-xs);
  padding: var(--sp-1) var(--sp-2); cursor: pointer;
  transition: all var(--dur-fast);
}
.dice-btn:hover { border-color: var(--accent); color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, transparent); }
.dice-btn.gm-dice {
  padding: var(--sp-2) var(--sp-4); font-size: var(--text-sm);
  border-color: var(--accent); color: var(--accent);
}
.dice-btn.gm-dice:hover { background: color-mix(in srgb, var(--accent) 15%, transparent); }

.dice-result-box {
  background: var(--bg-abyss); border: 1px solid var(--bg-border);
  border-radius: var(--radius-md); padding: var(--sp-2);
  font-family: var(--font-mono); font-size: var(--text-sm);
  min-height: 52px;
}
.dice-result-notation { color: var(--text-secondary); font-size: var(--text-xs); }
.dice-result-faces { display: flex; gap: var(--sp-1); flex-wrap: wrap; margin: var(--sp-1) 0; }
.die-face {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px;
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-sm); font-size: 1.1em;
  color: var(--text-primary);
}
.die-face.max { border-color: var(--confirm); color: var(--confirm); }
.die-face.min { border-color: var(--danger); color: var(--danger); }
.dice-result-total { color: var(--accent); font-size: var(--text-lg); font-weight: 600; }

/* â”€â”€ SCENE LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.log-entry { padding: var(--sp-2); border-bottom: 1px solid var(--bg-border); }
.log-entry:last-child { border-bottom: none; }
.log-entry-meta { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px; }
.log-entry.scene  .log-entry-content { font-style: italic; color: var(--text-primary); }
.log-entry.dice   .log-entry-content { font-family: var(--font-mono); color: var(--warning); }
.log-entry.image  .log-entry-content img { max-width: 100%; border-radius: var(--radius-sm); max-height: 120px; object-fit: cover; }
.log-entry.video  .log-entry-content { color: var(--accent); font-size: var(--text-xs); }

/* â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-messages {
  flex: 1; overflow-y: auto; display: flex;
  flex-direction: column; gap: var(--sp-1);
}
.chat-msg { font-size: var(--text-sm); line-height: 1.4; }
.chat-msg .chat-who { font-family: var(--font-mono); font-size: var(--text-xs); font-weight: 600; margin-right: var(--sp-1); }
.chat-msg .chat-text { color: var(--text-primary); }
.chat-row { display: flex; gap: var(--sp-2); }

/* â”€â”€ CHARACTER MINI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.char-mini { display: flex; flex-direction: column; gap: var(--sp-2); }
.char-mini-name { font-family: var(--font-display); font-size: var(--text-sm); color: var(--accent); }
.char-mini-bg { font-style: italic; font-size: var(--text-xs); color: var(--text-secondary); line-height: 1.5; white-space: normal; word-break: break-word; }
.char-stats { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-1); }
.stat-box {
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-sm); padding: var(--sp-1) var(--sp-2);
  text-align: center;
}
.stat-label { font-family: var(--font-mono); font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
.stat-value { font-family: var(--font-mono); font-size: var(--text-lg); color: var(--text-primary); font-weight: 600; }
.stat-musgo { grid-column: span 2; }
.musgo-pips { display: flex; gap: 4px; justify-content: center; margin-top: 2px; }
.musgo-pip {
  width: 14px; height: 14px; border-radius: 50%;
  border: 1px solid var(--bg-border); background: var(--bg-panel);
  transition: all var(--dur-base);
}
.musgo-pip.filled { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 6px rgba(13,110,82,.4); }
.musgo-pip.danger { background: var(--danger); border-color: var(--danger); box-shadow: 0 0 6px rgba(181,42,42,.4); }

/* â”€â”€ GM PLAYER TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gm-players-grid { display: flex; flex-direction: column; gap: var(--sp-2); }
.gm-player-row {
  background: var(--bg-panel); border: 1px solid var(--bg-border);
  border-radius: var(--radius-md); padding: var(--sp-2);
  display: grid; grid-template-columns: auto 1fr auto;
  gap: var(--sp-3); align-items: start;
}
.gm-player-row.offline { opacity: 0.4; }

/* â”€â”€ STORY LOG PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.log-panel {
  flex: 1; overflow-y: auto;
  display: flex; flex-direction: column;
}

/* â”€â”€ SECTION TITLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title {
  font-family: var(--font-mono); font-size: var(--text-xs);
  color: var(--accent); text-transform: uppercase; letter-spacing: .1em;
  padding-bottom: var(--sp-1); border-bottom: 1px solid var(--bg-border);
  margin-bottom: var(--sp-2);
}

/* â”€â”€ CHARACTER EDITOR MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.char-editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-3); }
.char-editor-grid .full-width { grid-column: span 2; }
.skill-table { width: 100%; border-collapse: collapse; font-size: var(--text-xs); }
.skill-table th { background: var(--bg-raised); color: var(--text-secondary); padding: var(--sp-1) var(--sp-2); font-family: var(--font-mono); text-align: left; }
.skill-table td { padding: var(--sp-1) var(--sp-2); border-bottom: 1px solid var(--bg-border); color: var(--text-primary); vertical-align: top; }
.skill-table tr:hover td { background: var(--bg-raised); }

/* â”€â”€ RULES MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rules-section { margin-bottom: var(--sp-4); }
.rules-section h3 { font-family: var(--font-display); color: var(--accent); font-size: var(--text-base); margin-bottom: var(--sp-2); }
.rules-section p, .rules-section li { font-size: var(--text-sm); line-height: 1.6; color: var(--text-primary); margin-bottom: var(--sp-1); }
.rules-section ul { padding-left: var(--sp-4); }
.rules-table { width: 100%; border-collapse: collapse; font-size: var(--text-xs); margin-top: var(--sp-2); }
.rules-table th { background: var(--bg-raised); color: var(--text-secondary); padding: var(--sp-1) var(--sp-2); font-family: var(--font-mono); text-align: left; }
.rules-table td { padding: var(--sp-1) var(--sp-2); border-bottom: 1px solid var(--bg-border); color: var(--text-primary); }



/* â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.has-tooltip { position: relative; cursor: help; }
.has-tooltip .tooltip {
  visibility: hidden; opacity: 0;
  position: absolute; left: 0; top: 100%; margin-top: 4px;
  background: var(--bg-panel); border: 1px solid var(--accent);
  color: var(--text-primary); font-family: var(--font-body);
  font-size: var(--text-sm); line-height: 1.5;
  padding: var(--sp-2) var(--sp-3);
  border-radius: var(--radius-md); box-shadow: var(--shadow-md);
  min-width: 240px; max-width: 340px; z-index: 500;
  transition: opacity var(--dur-fast); pointer-events: none;
  white-space: normal;
}
.has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }

/* â”€â”€ NPC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.npc-card {
  background: var(--bg-raised); border: 1px solid var(--bg-border);
  border-radius: var(--radius-md); padding: var(--sp-2);
  margin-bottom: var(--sp-2);
  display: grid; grid-template-columns: 1fr auto;
  gap: var(--sp-2); align-items: start;
}
.npc-card.hostile { border-left: 3px solid var(--danger); }
.npc-card.friendly { border-left: 3px solid var(--confirm); }
.npc-card.fearful  { border-left: 3px solid var(--warning); }
.npc-card.curious  { border-left: 3px solid var(--accent); }
.npc-name { font-weight: 600; font-size: var(--text-sm); color: var(--text-primary); }
.npc-meta { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-secondary); }
.npc-notes { font-size: var(--text-xs); color: var(--text-secondary); font-style: italic; line-height: 1.4; margin-top: 2px; white-space: normal; }
.npc-template-btn {
  background: var(--bg-panel); border: 1px solid var(--bg-border);
  border-radius: var(--radius-md); padding: var(--sp-2);
  cursor: pointer; text-align: left;
  transition: border-color var(--dur-fast), background var(--dur-fast);
}
.npc-template-btn:hover { border-color: var(--accent); background: var(--bg-raised); }
.npc-template-name { font-weight: 600; font-size: var(--text-sm); color: var(--text-primary); }
.npc-template-meta { font-size: var(--text-xs); color: var(--text-secondary); margin-top: 2px; }

/* Mobile adjustments */
@media (max-width: 768px) {
  .gm-body { grid-template-columns: 1fr; }
  .player-bottom { grid-template-columns: 1fr; }
  .char-editor-grid { grid-template-columns: 1fr; }
  .char-editor-grid .full-width { grid-column: span 1; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: NAME â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-name" class="screen">
  <div class="name-card anim-fade-in">
    <div class="name-title">Mundo Musgo</div>
    <div class="name-sub">Entra o nome que levarÃ¡ a esta mesa</div>
    <div style="display:flex;flex-direction:column;gap:var(--sp-3)">
      <input id="input-name" class="bg-input" type="text" maxlength="24" placeholder="O teu nome..." autocomplete="off" spellcheck="false">
      <button id="btn-confirm-name" class="bg-btn bg-btn-primary">Entrar â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: LOBBY â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lobby" class="screen">
  <div class="lobby-header">
    <div class="lobby-title">Mundo Musgo</div>
    <div style="color:var(--text-secondary);font-style:italic;font-size:var(--text-sm)">Escolhe uma mesa para entrar</div>
    <div style="margin-top:var(--sp-3);display:flex;gap:var(--sp-2);justify-content:center">
      <button class="bg-btn bg-btn-ghost" onclick="showRules()">ğŸ“– Regras</button>
    </div>
  </div>
  <div class="lobby-grid" id="lobby-grid"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN: GAME â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-game" class="screen">
  <!-- GM LAYOUT -->
  <div id="gm-layout" class="gm-layout" style="display:none">
    <div class="bg-topbar">
      <span class="bg-topbar-title">Mundo Musgo</span>
      <span id="gm-table-name" style="font-family:var(--font-mono);font-size:var(--text-xs);color:var(--text-secondary)"></span>
      <div class="bg-chip gm" style="--chip-color:var(--player-0)" id="gm-chip"></div>
      <button id="btn-lock-table" class="bg-btn bg-btn-ghost" onclick="toggleLockTable()" title="Fechar/Abrir mesa a novos jogadores">ğŸ”“ Aberta</button>
      <button class="bg-btn bg-btn-ghost" onclick="showRules()">ğŸ“–</button>
      <button class="bg-btn bg-btn-danger" onclick="leaveGame()">Sair</button>
    </div>
    <div class="gm-body">
      <!-- LEFT: Scene + Media + Dice -->
      <div class="gm-left">
        <div class="section-title">LocalizaÃ§Ã£o Actual</div>
        <div style="display:flex;gap:var(--sp-2)">
          <input id="gm-location-input" class="bg-input" type="text" maxlength="120" placeholder="Ex: Caverna PrÃ©-HistÃ³rica Â· Subsolo 3">
          <button class="bg-btn bg-btn-secondary" onclick="sendLocation()">ğŸ“</button>
        </div>

        <div class="section-title" style="margin-top:var(--sp-2)">Push de Media</div>
        <select id="gm-media-type" class="bg-input" style="margin-bottom:var(--sp-1)">
          <option value="image">ğŸ–¼ Imagem (URL)</option>
          <option value="video">â–¶ VÃ­deo (YouTube URL)</option>
        </select>
        <input id="gm-media-url" class="bg-input" type="text" placeholder="https://...">
        <div style="display:flex;gap:var(--sp-2);margin-top:var(--sp-1)">
          <button class="bg-btn bg-btn-warn" style="flex:1" onclick="pushMedia()">ğŸ“¤ Push</button>
          <button class="bg-btn bg-btn-ghost" onclick="clearMedia()">âœ•</button>
        </div>

        <div class="section-title" style="margin-top:var(--sp-2)">Dados do GM</div>
        <div class="dice-panel">
          <div class="dice-buttons" id="gm-dice-btns"></div>
          <div class="dice-result-box" id="gm-dice-result">
            <div style="color:var(--text-secondary);font-size:var(--text-xs)">Nenhum dado rolado.</div>
          </div>
        </div>

        <div class="section-title" style="margin-top:var(--sp-2)">Log da HistÃ³ria</div>
        <div class="log-panel" id="gm-log-panel"></div>
        <button class="bg-btn bg-btn-secondary" onclick="downloadLog()">â¬‡ Gravar Log JSON</button>

        <div class="section-title" style="margin-top:var(--sp-3)">Documentos</div>
        <div style="display:flex;flex-direction:column;gap:var(--sp-1)">
          <a href="/docs/mundo_musgo_gm.pdf" target="_blank" download class="bg-btn bg-btn-ghost" style="text-decoration:none;text-align:center">ğŸ“„ BÃ­blia do GM</a>
          <a href="/docs/mundo_musgo_season1.pdf" target="_blank" download class="bg-btn bg-btn-ghost" style="text-decoration:none;text-align:center">ğŸ“„ Starter Set Season 1</a>
        </div>
      </div>

      <!-- CENTER: Scene + Players -->
      <div class="gm-center">
        <div class="section-title">Cena â€” Texto para Jogadores</div>
        <textarea id="gm-scene-input" class="bg-textarea" rows="4" placeholder="Escreve a cena... o texto serÃ¡ enviado para todos os jogadores."></textarea>
        <div style="display:flex;gap:var(--sp-2);margin-bottom:var(--sp-3)">
          <button class="bg-btn bg-btn-primary" style="flex:1" onclick="sendScene()">ğŸ“¡ Enviar Cena</button>
          <button class="bg-btn bg-btn-ghost" onclick="clearScene()">âœ•</button>
        </div>

        <div class="section-title">Jogadores na Mesa</div>
        <div class="gm-players-grid" id="gm-players-grid"></div>

        <div class="section-title" style="margin-top:var(--sp-4)">NPCs em Cena</div>
        <div style="margin-bottom:var(--sp-2);display:flex;gap:var(--sp-2)">
          <button class="bg-btn bg-btn-secondary" style="flex:1" onclick="showNPCModal()">+ Criar NPC</button>
          <button class="bg-btn bg-btn-ghost" onclick="showNPCModal('template')">ğŸ“‹ Templates</button>
        </div>
        <div id="gm-npc-list"></div>
      </div>

      <!-- NPC strip at bottom of center -->
      <!-- (NPC list rendered by renderGM) -->

      <!-- RIGHT: Chat -->
      <div class="gm-right">
        <div class="section-title">Chat da Mesa</div>
        <div class="chat-messages" id="gm-chat-messages"></div>
        <div class="chat-row">
          <input id="gm-chat-input" class="bg-input" type="text" placeholder="Mensagem..." maxlength="500">
          <button class="bg-btn bg-btn-secondary" onclick="sendChat('gm')">â</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYER LAYOUT -->
  <div id="player-layout" class="player-layout" style="display:none">
    <div class="bg-topbar">
      <span class="bg-topbar-title">Mundo Musgo</span>
      <span id="player-table-name" style="font-family:var(--font-mono);font-size:var(--text-xs);color:var(--text-secondary)"></span>
      <div class="bg-chip" id="player-chip" style="--chip-color:var(--player-1)"></div>
      <button class="bg-btn bg-btn-ghost" onclick="showCharEditor()">ğŸ‘¤ Personagem</button>
      <button class="bg-btn bg-btn-ghost" onclick="showRules()">ğŸ“–</button>
      <button class="bg-btn bg-btn-danger" onclick="leaveGame()">Sair</button>
    </div>

    <!-- Location bar -->
    <div id="player-location-bar" style="display:none;background:var(--bg-abyss);border-bottom:1px solid var(--bg-border);padding:var(--sp-1) var(--sp-4);display:flex;align-items:center;gap:var(--sp-2)">
      <span style="font-family:var(--font-mono);font-size:var(--text-xs);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;">ğŸ“ LocalizaÃ§Ã£o:</span>
      <span id="player-location-text" style="font-family:var(--font-mono);font-size:var(--text-sm);color:var(--accent);font-weight:600"></span>
    </div>

    <!-- Scene text from GM -->
    <div class="scene-area">
      <div id="player-scene-text" class="scene-text-display empty">Aguardando o GM...</div>
    </div>

    <!-- Media push from GM -->
    <div class="media-area empty" id="player-media-area"></div>

    <!-- Other players row -->
    <div class="player-mid" id="player-mid"></div>

    <!-- Bottom: char + dice + chat -->
    <div class="player-bottom">
      <!-- My character mini -->
      <div>
        <div class="section-title">Personagem</div>
        <div class="char-mini" id="char-mini"></div>
        <button class="bg-btn bg-btn-ghost" style="width:100%;margin-top:var(--sp-2)" onclick="showCharEditor()">âœ Editar</button>

        <div class="section-title" style="margin-top:var(--sp-3)">Ãšltima AcÃ§Ã£o</div>
        <textarea id="action-input" class="bg-textarea" rows="3" placeholder="O que estÃ¡s a fazer? (visÃ­vel para todos)"></textarea>
        <button class="bg-btn bg-btn-secondary" style="width:100%;margin-top:var(--sp-1)" onclick="sendAction()">Confirmar AcÃ§Ã£o</button>
      </div>

      <!-- Dice -->
      <div>
        <div class="section-title">Dados</div>
        <div class="dice-panel">
          <div class="dice-buttons" id="player-dice-btns"></div>
          <div class="dice-result-box" id="player-dice-result">
            <div style="color:var(--text-secondary);font-size:var(--text-xs)">Nenhum dado rolado.</div>
          </div>
        </div>

        <div class="section-title" style="margin-top:var(--sp-3)">Log Recente</div>
        <div id="player-log-mini" style="flex:1;overflow-y:auto;font-size:var(--text-xs)"></div>
      </div>

      <!-- Chat -->
      <div>
        <div class="section-title">Chat da Mesa</div>
        <div class="chat-messages" id="player-chat-messages"></div>
        <div class="chat-row">
          <input id="player-chat-input" class="bg-input" type="text" placeholder="Mensagem..." maxlength="500">
          <button class="bg-btn bg-btn-secondary" onclick="sendChat('player')">â</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• MODAL: CHARACTER EDITOR â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-char" class="bg-modal-overlay hidden">
  <div class="bg-modal-box">
    <div class="bg-modal-header">
      <span class="bg-modal-title">Personagem</span>
      <div style="display:flex;gap:var(--sp-2)">
        <button class="bg-btn bg-btn-ghost" onclick="loadCharFromFile()">ğŸ“‚ Carregar</button>
        <button class="bg-btn bg-btn-ghost" onclick="saveCharToFile()">ğŸ’¾ Gravar</button>
        <button class="bg-btn bg-btn-ghost" onclick="hideCharEditor()">âœ•</button>
      </div>
    </div>

    <div class="char-editor-grid">
      <div>
        <label class="bg-label">Nome</label>
        <input id="ce-name" class="bg-input" type="text" maxlength="60" placeholder="Nome do personagem">
      </div>
      <div>
        <label class="bg-label">Background (D66 ou livre)</label>
        <div style="display:flex;gap:var(--sp-2)">
          <input id="ce-background" class="bg-input" type="text" maxlength="200" placeholder="Uma linha que define quem Ã©s">
          <button class="bg-btn bg-btn-secondary" onclick="rollBackground()" title="Rolar D66 para background aleatÃ³rio" style="white-space:nowrap;flex-shrink:0">ğŸ² D66</button>
        </div>
      </div>
      <div class="full-width">
        <label class="bg-label">MotivaÃ§Ã£o</label>
        <input id="ce-motivation" class="bg-input" type="text" maxlength="200" placeholder="Por que estÃ¡s aqui?">
      </div>
      <div>
        <label class="bg-label">Virtude</label>
        <input id="ce-virtue" class="bg-input" type="text" maxlength="200" placeholder="O que te faz brilhar?">
      </div>
      <div>
        <label class="bg-label">Medo</label>
        <input id="ce-fear" class="bg-input" type="text" maxlength="200" placeholder="O que te persegue?">
      </div>
      <div class="full-width">
        <label class="bg-label">Linhagem</label>
        <input id="ce-lineage" class="bg-input" type="text" maxlength="200" placeholder="De onde vens?">
      </div>

      <div>
        <label class="bg-label">ForÃ§a</label>
        <div style="display:flex;gap:var(--sp-2);align-items:center">
          <input id="ce-forca" class="bg-input" type="number" min="0" max="99" value="22" style="width:80px">
          <button class="bg-btn bg-btn-ghost" onclick="rollForca()">ğŸ² 3d6+10</button>
        </div>
      </div>
      <div>
        <label class="bg-label">Sorte</label>
        <div style="display:flex;gap:var(--sp-2);align-items:center">
          <input id="ce-sorte" class="bg-input" type="number" min="0" max="20" value="5" style="width:80px">
          <button class="bg-btn bg-btn-ghost" onclick="rollSorte()">ğŸ² 1d6+2</button>
        </div>
      </div>
      <div>
        <label class="bg-label">Musgo (0â€“6)</label>
        <input id="ce-musgo" class="bg-input" type="number" min="0" max="6" value="0" style="width:80px">
      </div>
      <div>
        <label class="bg-label">XP</label>
        <input id="ce-xp" class="bg-input" type="number" min="0" max="99" value="0" style="width:80px">
      </div>

      <div>
        <label class="bg-label">Habilidade Especial (D6)</label>
        <div style="display:flex;gap:var(--sp-2);align-items:center">
          <select id="ce-skill" class="bg-input">
            <option value="0">â€” Rolar D6 â€”</option>
            <option value="1">1 â€” ForÃ§a Mutante (+2 ForÃ§a permanente)</option>
            <option value="2">2 â€” InfecÃ§Ã£o (prÃ³ximo ataque +2 dano)</option>
            <option value="3">3 â€” Defesa Robusta (ignora 2 dano)</option>
            <option value="4">4 â€” Sorte Programada (evita combate)</option>
            <option value="5">5 â€” Conhecimento (+2 XP)</option>
            <option value="6">6 â€” Dado Adquirido (rola 2 dados, fica melhor)</option>
          </select>
          <button class="bg-btn bg-btn-ghost" onclick="rollSkill()">ğŸ²</button>
        </div>
      </div>

      <div class="full-width">
        <label class="bg-label">Notas Livres</label>
        <textarea id="ce-notes" class="bg-textarea" rows="4" placeholder="Equipamento, memÃ³rias, afectaÃ§Ãµes de Musgo..."></textarea>
      </div>
    </div>

    <div style="margin-top:var(--sp-4)">
      <div class="section-title">Tabela de Habilidades</div>
      <table class="skill-table">
        <thead><tr><th>D6</th><th>Habilidade</th><th>Efeito</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>ForÃ§a Mutante</td><td>+2 ForÃ§a permanentemente</td></tr>
          <tr><td>2</td><td>InfecÃ§Ã£o</td><td>PrÃ³ximo ataque causa +2 dano</td></tr>
          <tr><td>3</td><td>Defesa Robusta</td><td>Ignora 2 pontos do prÃ³ximo ataque recebido</td></tr>
          <tr><td>4</td><td>Sorte Programada</td><td>Evita um combate completamente (sem dados)</td></tr>
          <tr><td>5</td><td>Conhecimento</td><td>Ganha 2 XP imediatamente</td></tr>
          <tr><td>6</td><td>Dado Adquirido</td><td>Em qualquer teste, rola 2 dados e fica com o melhor</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:var(--sp-4);display:flex;justify-content:flex-end;gap:var(--sp-2)">
      <button class="bg-btn bg-btn-ghost" onclick="hideCharEditor()">Cancelar</button>
      <button class="bg-btn bg-btn-primary" onclick="saveChar()">Guardar Personagem</button>
    </div>

    <input type="file" id="char-file-input" accept=".json" style="display:none" onchange="loadCharFile(event)">
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• MODAL: RULES â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-rules" class="bg-modal-overlay hidden">
  <div class="bg-modal-box">
    <div class="bg-modal-header">
      <span class="bg-modal-title">Regras â€” Mundo Musgo</span>
      <button class="bg-btn bg-btn-ghost" onclick="hideRules()">âœ•</button>
    </div>
    <div class="rules-section">
      <h3>Atributos</h3>
      <ul>
        <li><strong>ForÃ§a</strong> â€” ResistÃªncia fÃ­sica. 3d6+10. Restaura apÃ³s cada combate.</li>
        <li><strong>Sorte</strong> â€” Destino. 1d6+2. Restaura ao descansar na Base.</li>
        <li><strong>Musgo</strong> â€” LigaÃ§Ã£o ao fenÃ³meno. ComeÃ§a em 0. Cresce por escolha.</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>Combate</h3>
      <ul>
        <li>Ambos rolam 1d6 + ForÃ§a. Maior ganha. Perdedor perde 2 ForÃ§a.</li>
        <li><strong>Fuga:</strong> 1d6 â‰¤ Sorte â†’ fuga + 1 XP. Falha â†’ -3 ForÃ§a.</li>
        <li><strong>Ajudar aliado:</strong> Divide ForÃ§a a meio, dÃ¡ metade a aliado com ForÃ§a 0.</li>
        <li>Cada 3 XP: +2 ForÃ§a OU +1 Sorte.</li>
      </ul>
    </div>
    <div class="rules-section">
      <h3>O Musgo</h3>
      <ul>
        <li>O GM anuncia: <em>"Deixas entrar ou resistis?"</em></li>
        <li>Resistir: custa 1 Sorte. Deixar entrar: Musgo +1.</li>
      </ul>
      <table class="rules-table">
        <thead><tr><th>Musgo</th><th>Estado</th><th>AfectaÃ§Ã£o (falha Sorte)</th></tr></thead>
        <tbody>
          <tr><td>0</td><td>Humano comum</td><td>â€”</td></tr>
          <tr><td>1â€“2</td><td>Sintonizado</td><td>AlucinaÃ§Ãµes â€” perde 1 turno</td></tr>
          <tr><td>3â€“4</td><td>Ressonante</td><td>DissociaÃ§Ã£o â€” guiado D6 turnos</td></tr>
          <tr><td>5</td><td>Contemplativo</td><td>Coma â€” outro jogador carrega-te</td></tr>
          <tr><td>6</td><td>Transformado</td><td>Tu narras a transformaÃ§Ã£o</td></tr>
        </tbody>
      </table>
    </div>
    <div class="rules-section">
      <h3>Habilidades Especiais (1 uso por aventura)</h3>
      <table class="rules-table">
        <thead><tr><th>D6</th><th>Habilidade</th><th>Efeito</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>ForÃ§a Mutante</td><td>+2 ForÃ§a permanente</td></tr>
          <tr><td>2</td><td>InfecÃ§Ã£o</td><td>PrÃ³ximo ataque +2 dano</td></tr>
          <tr><td>3</td><td>Defesa Robusta</td><td>Ignora 2 dano do prÃ³ximo ataque</td></tr>
          <tr><td>4</td><td>Sorte Programada</td><td>Evita combate (automÃ¡tico)</td></tr>
          <tr><td>5</td><td>Conhecimento</td><td>+2 XP imediatos</td></tr>
          <tr><td>6</td><td>Dado Adquirido</td><td>Rola 2 dados, fica com o melhor</td></tr>
        </tbody>
      </table>
    </div>
    <button class="bg-btn bg-btn-secondary" onclick="hideRules()" style="width:100%">Fechar</button>
  </div>
</div>




<!-- â•â•â•â•â•â•â•â•â•â•â• MODAL: NPC â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-npc" class="bg-modal-overlay hidden">
  <div class="bg-modal-box" style="width:min(620px,96vw)">
    <div class="bg-modal-header">
      <span class="bg-modal-title" id="npc-modal-title">Criar NPC</span>
      <button class="bg-btn bg-btn-ghost" onclick="hideNPCModal()">âœ•</button>
    </div>

    <!-- Template picker -->
    <div id="npc-template-section" style="margin-bottom:var(--sp-4)">
      <div class="bg-label">Templates do Starter Set</div>
      <div id="npc-template-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--sp-2);margin-top:var(--sp-2)"></div>
    </div>

    <div style="border-top:1px solid var(--bg-border);padding-top:var(--sp-3);margin-top:var(--sp-1)">
      <div class="bg-label">Ou cria um NPC personalizado</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-3);margin-top:var(--sp-3)">
      <div>
        <label class="bg-label">Nome</label>
        <input id="npc-name" class="bg-input" type="text" maxlength="60" placeholder="Nome do NPC">
      </div>
      <div>
        <label class="bg-label">FacÃ§Ã£o / Tipo</label>
        <input id="npc-faction" class="bg-input" type="text" maxlength="60" placeholder="Ex: Limiar, Baelfungious...">
      </div>
      <div>
        <label class="bg-label">ForÃ§a</label>
        <div style="display:flex;gap:var(--sp-2);align-items:center">
          <input id="npc-forca" class="bg-input" type="number" min="1" max="99" value="15" style="width:70px">
          <button class="bg-btn bg-btn-ghost" onclick="rollNPCForca()">ğŸ²</button>
        </div>
      </div>
      <div>
        <label class="bg-label">Comportamento</label>
        <select id="npc-behavior" class="bg-input">
          <option value="Neutral">Neutro</option>
          <option value="Hostile">Hostil</option>
          <option value="Friendly">AmigÃ¡vel</option>
          <option value="Fearful">Com medo</option>
          <option value="Curious">Curioso</option>
        </select>
      </div>
      <div style="grid-column:span 2">
        <label class="bg-label">DescriÃ§Ã£o / Notas</label>
        <textarea id="npc-notes" class="bg-textarea" rows="3" placeholder="AparÃªncia, motivaÃ§Ã£o, segredos..."></textarea>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:var(--sp-2);margin-top:var(--sp-4)">
      <button class="bg-btn bg-btn-ghost" onclick="hideNPCModal()">Cancelar</button>
      <button class="bg-btn bg-btn-primary" onclick="spawnNPC()">Invocar NPC</button>
    </div>
  </div>
</div>

<!-- Banner -->
<div id="bg-banner" class="bg-banner"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws, myName, myToken, myLobbyId, mySeat, amGM = false;
let cachedLobbies = [];
let gameState = null;

const SKILL_NAMES = {
  1: 'ForÃ§a Mutante', 2: 'InfecÃ§Ã£o', 3: 'Defesa Robusta',
  4: 'Sorte Programada', 5: 'Conhecimento', 6: 'Dado Adquirido'
};
const SKILL_FX = {
  1: '+2 ForÃ§a permanente', 2: '+2 dano no prÃ³ximo ataque',
  3: 'Ignora 2 dano', 4: 'Evita combate', 5: '+2 XP', 6: 'Rola 2 dados, fica melhor'
};

// Dice sets
const PLAYER_DICE  = ['1d4','1d6','2d6','3d6','1d8','1d10','1d12','1d20'];
const GM_DICE      = ['1d6','2d6','3d6','1d20','1d4','1d8','1d10','1d12'];

// D6 faces (unicode)
const D6_FACES = ['âš€','âš','âš‚','âšƒ','âš„','âš…'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showBanner(text, variant = '') {
  const b = document.getElementById('bg-banner');
  b.textContent = text;
  b.className = 'bg-banner show' + (variant ? ' ' + variant : '');
  clearTimeout(b._t);
  b._t = setTimeout(() => b.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host);

  ws.onopen = () => {
    const tok = sessionStorage.getItem('mm_token');
    if (tok) ws.send(JSON.stringify({ type: 'RECONNECT', token: tok }));
    else     ws.send(JSON.stringify({ type: 'LOBBIES' }));
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    switch (msg.type) {

      case 'PONG': break;

      case 'LOBBIES':
        cachedLobbies = msg.lobbies;
        if (myName && document.getElementById('screen-lobby').classList.contains('active'))
          renderLobbyList(msg.lobbies);
        break;

      case 'JOINED':
        myToken   = msg.token;
        myLobbyId = msg.lobbyId;
        mySeat    = msg.seat;
        amGM      = msg.isGM;
        sessionStorage.setItem('mm_token', myToken);
        showBanner(amGM ? 'ğŸŒ¿ Entraste como GM' : 'ğŸŒ¿ Entraste na mesa', 'confirm');
        break;

      case 'RECONNECTED':
        myToken   = sessionStorage.getItem('mm_token');
        myName    = msg.name;
        myLobbyId = msg.lobbyId;
        mySeat    = msg.seat;
        amGM      = msg.isGM;
        break;

      case 'RECONNECT_FAIL':
        sessionStorage.removeItem('mm_token');
        myToken = null; myName = null; myLobbyId = null;
        showScreen('screen-name');
        break;

      case 'GAME_STATE':
        gameState = msg.state;
        showScreen('screen-game');
        renderGame(msg.state);
        break;

      case 'LEFT':
        showScreen('screen-lobby');
        renderLobbyList(cachedLobbies);
        send({ type: 'LOBBIES' });
        break;

      case 'ERROR':
        showBanner('âš  ' + msg.text, 'danger');
        break;
    }
  };

  ws.onclose = () => setTimeout(connect, 1500);
}

function send(data) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(data));
}

setInterval(() => send({ type: 'PING' }), 15000);
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && ws && ws.readyState !== 1) connect();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLobbyList(lobbies) {
  showScreen('screen-lobby');
  const grid = document.getElementById('lobby-grid');
  grid.innerHTML = '';
  lobbies.forEach(l => {
    const card = document.createElement('div');
    card.className = 'mesa-card anim-fade-in';
    const occupied = l.playerCount;
    const statusText = l.locked
      ? `<span style="color:var(--danger)">ğŸ”’ Fechada</span>`
      : l.inGame
        ? `<span style="color:var(--warning)">â— Em Jogo</span>`
        : `<span style="color:var(--confirm)">â— Aberta</span>`;
    const pipsHtml = l.playerNames.map((n, i) =>
      `<div class="bg-chip" style="--chip-color:var(--player-${i})">${i===0?'â¬¡ ':''}${n}</div>`
    ).join('');
    const gmInfo = l.hasGM
      ? `<div class="mesa-card-gm">GM: ${l.playerNames[0]||'?'}</div>`
      : `<div class="mesa-card-gm" style="color:var(--accent)">Primeiro a entrar serÃ¡ GM</div>`;
    const canJoin = !l.locked && occupied < l.maxPlayers;
    card.innerHTML = `
      <div class="mesa-card-name">${l.name}</div>
      <div class="mesa-card-status">${statusText} Â· ${occupied}/${l.maxPlayers} jogadores</div>
      ${gmInfo}
      <div class="mesa-card-players">${pipsHtml || '<span style="color:var(--text-secondary);font-size:var(--text-xs)">Vazia</span>'}</div>
      <button class="bg-btn ${canJoin?'bg-btn-primary':'bg-btn-ghost'}" ${canJoin?'':'disabled'} onclick="joinLobby('${l.id}')">
        ${l.locked ? 'ğŸ”’ Fechada' : canJoin ? 'Entrar â†’' : 'Cheia'}
      </button>
    `;
    grid.appendChild(card);
  });
}

function joinLobby(lobbyId) {
  send({ type: 'JOIN_LOBBY', lobbyId, playerName: myName });
}

function leaveGame() {
  send({ type: 'LEAVE_LOBBY' });
  sessionStorage.removeItem('mm_token');
  myToken = null; myLobbyId = null; amGM = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME RENDER â€” full redraw
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGame(state) {
  if (!state) return;

  const isGM = state.isGM;
  document.getElementById('gm-layout').style.display     = isGM ? 'grid' : 'none';
  document.getElementById('player-layout').style.display = isGM ? 'none' : 'grid';

  if (isGM) renderGM(state);
  else       renderPlayer(state);
}

// â”€â”€ GM RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGM(state) {
  // Topbar
  document.getElementById('gm-table-name').textContent = state.tableName;
  // Sync GM location input if server has a value
  const locInput = document.getElementById('gm-location-input');
  if (locInput && state.location && !locInput.matches(':focus')) {
    locInput.value = state.location;
  }
  const me = state.players.find(p => p.seat === state.mySeat);
  if (me) {
    const chip = document.getElementById('gm-chip');
    chip.textContent = 'â¬¡ ' + me.name;
    chip.style.setProperty('--chip-color', me.color);
  }
  // Update lock button
  const lockBtn = document.getElementById('btn-lock-table');
  if (lockBtn) {
    if (state.locked) {
      lockBtn.textContent = 'ğŸ”’ Fechada';
      lockBtn.style.color = 'var(--danger)';
      lockBtn.style.borderColor = 'rgba(248,113,113,.4)';
    } else {
      lockBtn.textContent = 'ğŸ”“ Aberta';
      lockBtn.style.color = '';
      lockBtn.style.borderColor = '';
    }
  }

  // Dice buttons (build once)
  const gmBtns = document.getElementById('gm-dice-btns');
  if (!gmBtns.children.length) {
    GM_DICE.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'dice-btn gm-dice';
      btn.textContent = d.toUpperCase();
      btn.onclick = () => rollDice(d);
      gmBtns.appendChild(btn);
    });
  }

  // My dice result
  const myPlayer = state.players.find(p => p.seat === state.mySeat);
  if (myPlayer?.diceResults) {
    renderDiceResult('gm-dice-result', myPlayer.diceResults);
  }

  // Players grid
  const grid = document.getElementById('gm-players-grid');
  grid.innerHTML = '';
  state.players.forEach(p => {
    const row = document.createElement('div');
    row.className = 'gm-player-row' + (p.online ? '' : ' offline');
    const char = p.character || {};
    const musgo = char.musgo || 0;
    const mugoPips = Array.from({length:6},(_,i) => `<span class="musgo-pip${i<musgo?' filled':''}"></span>`).join('');
    const diceHtml = p.diceResults
      ? `<div class="player-card-dice">${p.diceResults.notation} = ${p.diceResults.total}</div>`
      : '';
    const tooltipContent = [
      char.background ? `<strong>Background:</strong> ${char.background}` : '',
      char.motivation ? `<strong>MotivaÃ§Ã£o:</strong> ${char.motivation}` : '',
      char.virtue     ? `<strong>Virtude:</strong> ${char.virtue}` : '',
      char.fear       ? `<strong>Medo:</strong> ${char.fear}` : '',
      char.lineage    ? `<strong>Linhagem:</strong> ${char.lineage}` : '',
    ].filter(Boolean).join('<br>');
    row.innerHTML = `
      <div>
        <div class="has-tooltip">
          <div class="bg-chip${p.isGM?' gm':''}" style="--chip-color:${p.color}">${p.isGM?'â¬¡ ':''}${p.name}</div>
          ${tooltipContent ? `<div class="tooltip">${tooltipContent}</div>` : ''}
        </div>
        <div style="font-size:var(--text-xs);color:var(--text-secondary);margin-top:4px">${p.online?'â— Online':'â—‹ Offline'}</div>
      </div>
      <div>
        ${char.name ? `<div style="color:var(--text-primary);font-size:var(--text-sm)">${char.name}</div>` : ''}
        ${char.background ? `<div style="color:var(--text-secondary);font-size:var(--text-xs);font-style:italic;white-space:normal;line-height:1.4">${char.background}</div>` : ''}
        ${p.lastAction ? `<div style="color:var(--warning);font-size:var(--text-xs);margin-top:4px">â†³ ${p.lastAction}</div>` : ''}
        <div style="display:flex;gap:var(--sp-3);margin-top:var(--sp-1);font-family:var(--font-mono);font-size:var(--text-xs);color:var(--text-secondary)">
          ${char.forca !== undefined ? `<span>F:<strong style="color:var(--text-primary)">${char.forca}</strong></span>` : ''}
          ${char.sorte !== undefined ? `<span>S:<strong style="color:var(--text-primary)">${char.sorte}</strong></span>` : ''}
          ${char.xp   !== undefined ? `<span>XP:<strong style="color:var(--text-primary)">${char.xp}</strong></span>` : ''}
          <span>M:<span style="letter-spacing:2px">${mugoPips}</span></span>
        </div>
        ${diceHtml}
      </div>
      <div style="min-width:80px;display:flex;flex-direction:column;gap:var(--sp-1);align-items:flex-end">
        ${p.diceResults ? `<div style="font-family:var(--font-mono);font-size:var(--text-xs);color:var(--warning);text-align:right">
          ${p.diceResults.notation}<br><strong style="font-size:var(--text-base)">${p.diceResults.total}</strong>
        </div>` : ''}
        ${!p.isGM ? `<button class="bg-btn bg-btn-danger" style="padding:2px 8px;font-size:0.7rem" onclick="killPlayer(${p.seat})">â˜  Abater</button>` : ''}
      </div>
    `;
    grid.appendChild(row);
  });

  // NPCs
  renderNPCList(state.npcs || []);

  // Chat
  renderChat('gm-chat-messages', state.chat);

  // Log
  renderLog('gm-log-panel', state.sceneLog);
}

// â”€â”€ PLAYER RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPlayer(state) {
  document.getElementById('player-table-name').textContent = state.tableName;

  const me = state.players.find(p => p.seat === state.mySeat);
  if (me) {
    const chip = document.getElementById('player-chip');
    chip.textContent = me.name;
    chip.style.setProperty('--chip-color', me.color);
  }

  // Location bar
  const locBar  = document.getElementById('player-location-bar');
  const locText = document.getElementById('player-location-text');
  if (state.location) {
    locBar.style.display  = 'flex';
    locText.textContent   = state.location;
  } else {
    locBar.style.display  = 'none';
  }

  // Scene text
  const sceneEl = document.getElementById('player-scene-text');
  if (state.sceneText) {
    sceneEl.textContent = state.sceneText;
    sceneEl.classList.remove('empty');
  } else {
    sceneEl.textContent = 'Aguardando o GM...';
    sceneEl.classList.add('empty');
  }

  // Media
  const mediaEl = document.getElementById('player-media-area');
  if (state.mediaPush) {
    mediaEl.classList.remove('empty');
    if (state.mediaPush.type === 'image') {
      mediaEl.innerHTML = `<img src="${escHtml(state.mediaPush.data)}" alt="GM media">`;
    } else if (state.mediaPush.type === 'video') {
      const ytId = extractYoutubeId(state.mediaPush.data);
      if (ytId) {
        mediaEl.innerHTML = `<iframe src="https://www.youtube.com/embed/${ytId}?autoplay=0" allowfullscreen style="width:100%;height:250px;border:none"></iframe>`;
      } else {
        mediaEl.innerHTML = `<video src="${escHtml(state.mediaPush.data)}" controls style="width:100%;max-height:250px"></video>`;
      }
    }
  } else {
    mediaEl.classList.add('empty');
    mediaEl.innerHTML = '';
  }

  // Other players row
  const mid = document.getElementById('player-mid');
  mid.innerHTML = '';
  state.players.filter(p => p.seat !== state.mySeat).forEach(p => {
    const card = document.createElement('div');
    card.className = 'player-card' + (p.isGM ? ' is-gm' : '');
    const char = p.character || {};
    const musgo = char.musgo || 0;
    const mugoPips = Array.from({length:6},(_,i) =>
      `<span class="musgo-pip${i<musgo?(musgo>=5?' danger':' filled'):''}"></span>`).join('');
    const diceHtml = p.diceResults
      ? `<div class="player-card-dice">${renderDiceFacesInline(p.diceResults)} = ${p.diceResults.total}</div>`
      : '';
    card.innerHTML = `
      <div class="player-card-name" style="color:${p.color}">${p.isGM?'â¬¡ GM: ':''}${p.name}${p.online?'':' â—‹'}</div>
      ${char.name ? `<div style="font-size:var(--text-xs);color:var(--text-secondary)">${char.name}</div>` : ''}
      <div class="player-card-stats">
        ${char.forca !== undefined ? `<span>F:${char.forca}</span>` : ''}
        ${char.sorte !== undefined ? `<span>S:${char.sorte}</span>` : ''}
        ${char.xp   !== undefined ? `<span>XP:${char.xp}</span>` : ''}
      </div>
      <div class="musgo-pips" title="Musgo: ${musgo}">${mugoPips}</div>
      ${p.lastAction ? `<div class="player-card-action">â†³ ${p.lastAction}</div>` : ''}
      ${diceHtml}
    `;
    mid.appendChild(card);
  });

  // Char mini
  if (me) renderCharMini(me.character);

  // Dice buttons (build once)
  const playerBtns = document.getElementById('player-dice-btns');
  if (!playerBtns.children.length) {
    PLAYER_DICE.forEach(d => {
      const btn = document.createElement('button');
      btn.className = 'dice-btn';
      btn.textContent = d.toUpperCase();
      btn.onclick = () => rollDice(d);
      playerBtns.appendChild(btn);
    });
  }

  // My dice result
  if (me?.diceResults) {
    renderDiceResult('player-dice-result', me.diceResults);
  }

  // Chat
  renderChat('player-chat-messages', state.chat);

  // Mini log
  renderLogMini('player-log-mini', state.sceneLog);
}

// â”€â”€ CHAR MINI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharMini(char) {
  const el = document.getElementById('char-mini');
  if (!char || !char.name) {
    el.innerHTML = `<div style="color:var(--text-secondary);font-size:var(--text-xs);font-style:italic">
      Sem personagem. Clica "Editar" para criar.
    </div>`;
    return;
  }
  const musgo = char.musgo || 0;
  const mugoPips = Array.from({length:6},(_,i) =>
    `<span class="musgo-pip${i<musgo?(musgo>=5?' danger':' filled'):''}"></span>`).join('');
  const skillD6 = parseInt(char.skill?.d6) || 0;
  el.innerHTML = `
    <div class="char-mini-name">${char.name}</div>
    ${char.background ? `<div class="char-mini-bg">${char.background}</div>` : ''}
    <div class="char-stats">
      <div class="stat-box">
        <div class="stat-label">ForÃ§a</div>
        <div class="stat-value">${char.forca||0}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Sorte</div>
        <div class="stat-value">${char.sorte||0}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">XP</div>
        <div class="stat-value">${char.xp||0}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Hab.</div>
        <div class="stat-value" style="font-size:var(--text-sm)">${skillD6||'â€”'}</div>
      </div>
      <div class="stat-box stat-musgo">
        <div class="stat-label">Musgo ${musgo}/6</div>
        <div class="musgo-pips">${mugoPips}</div>
      </div>
    </div>
    ${char.notes ? `<div style="font-size:var(--text-xs);color:var(--text-secondary);font-style:italic;line-height:1.3">${char.notes.slice(0,100)}</div>` : ''}
  `;
}

// â”€â”€ DICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rollDice(notation) {
  send({ type: 'ROLL_DICE', notation });
  showBanner(`ğŸ² ${notation.toUpperCase()} rolado`);
}

function renderDiceFacesInline(result) {
  if (!result) return '';
  const isD6 = result.notation.includes('d6');
  return result.rolls.map(r => {
    if (isD6 && r >= 1 && r <= 6) return D6_FACES[r-1];
    return r;
  }).join(' ');
}

function renderDiceResult(elId, result) {
  const el = document.getElementById(elId);
  if (!result) { el.innerHTML = '<div style="color:var(--text-secondary);font-size:var(--text-xs)">Nenhum dado rolado.</div>'; return; }
  const isD6 = result.notation.includes('d6');
  const max = Math.max(...result.rolls);
  const min = Math.min(...result.rolls);
  const faces = result.rolls.map(r => {
    const isMax = r === max && result.rolls.length > 1;
    const isMin = r === min && result.rolls.length > 1;
    const cls   = isMax ? ' max' : isMin ? ' min' : '';
    const face  = (isD6 && r >= 1 && r <= 6) ? D6_FACES[r-1] : r;
    return `<span class="die-face${cls}">${face}</span>`;
  }).join('');
  el.innerHTML = `
    <div class="dice-result-notation">${result.notation.toUpperCase()} Â· ${result.rolledBy || ''}</div>
    <div class="dice-result-faces">${faces}</div>
    <div class="dice-result-total">= ${result.total}</div>
  `;
}

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChat(elId, chat) {
  const el = document.getElementById(elId);
  const wasBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 20;
  el.innerHTML = '';
  (chat || []).forEach(m => {
    const div = document.createElement('div');
    div.className = 'chat-msg';
    const col = `var(--player-${m.seat||0})`;
    div.innerHTML = `<span class="chat-who" style="color:${col}">${m.isGM?'[GM] ':''}${escHtml(m.name)}:</span><span class="chat-text">${escHtml(m.text)}</span>`;
    el.appendChild(div);
  });
  if (wasBottom) el.scrollTop = el.scrollHeight;
}

function sendChat(who) {
  const inputId = who === 'gm' ? 'gm-chat-input' : 'player-chat-input';
  const el = document.getElementById(inputId);
  const text = el.value.trim();
  if (!text) return;
  send({ type: 'CHAT', text });
  el.value = '';
}

// â”€â”€ SCENE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const D66_BACKGROUNDS = {
  11: "OceanÃ³grafa que hÃ¡ trÃªs anos nÃ£o consegue distinguir se os seus sonhos acontecem antes ou depois de adormecer",
  12: "Percussionista de mÃºsica experimental contratado porque a ColigaÃ§Ã£o acredita que o Musgo responde a ritmo",
  13: "CrianÃ§a prodÃ­gio de 11 anos que desenha mapas de lugares onde nunca esteve com precisÃ£o cartogrÃ¡fica",
  14: "Ex-mineiro que sobreviveu 40 dias soterrado e desde entÃ£o vÃª as paredes a respirar â€” e acha isso normal",
  15: "Perfumista que consegue cheirar emoÃ§Ãµes em pessoas e hÃ¡ seis meses detecta algo novo que nÃ£o tem nome",
  16: "Monge que abandonou o mosteiro apÃ³s uma meditaÃ§Ã£o que durou aparentemente trÃªs segundos e subjectivamente trinta anos",
  21: "Taxidermista obcecada com a ideia de que os animais que prepara continuam a comunicar entre si",
  22: "Programador que acredita ter encontrado nas sequÃªncias do Musgo uma linguagem mais antiga que o ADN",
  23: "FotÃ³grafa cujas fotos revelam detalhes que ela prÃ³pria nÃ£o viu ao fotografar",
  24: "GeÃ³loga que fala com rochas nÃ£o metaforicamente â€” e de vez em quando elas respondem",
  25: "Apicultor que perdeu todas as abelhas numa noite e encontrou-as trÃªs semanas depois formando padrÃµes no oceano",
  26: "Enfermeira de cuidados paliativos que descreve o momento da morte como uma porta que nunca fecha completamente",
  31: "Linguista especializada em lÃ­nguas extintas que comeÃ§ou a escrever numa que nÃ£o reconhece",
  32: "Chef que desde o contacto com o Musgo sÃ³ cozinha sabores que as pessoas descrevem como memÃ³rias de infÃ¢ncia que nÃ£o tiveram",
  33: "Astronauta reformada convicta de que o espaÃ§o exterior e o interior sÃ£o a mesma coisa vista de Ã¢ngulos diferentes",
  34: "BotÃ¢nica de 78 anos que afirma que as plantas sempre foram a forma de inteligÃªncia dominante",
  35: "Artista plÃ¡stico que sÃ³ trabalha de olhos fechados e cujas obras parecem imagens de satÃ©lite de zonas afectadas",
  36: "Psiquiatra que tratou doze casos de sÃ­ndrome de Musgo e desenvolveu todos os sintomas sem sair do consultÃ³rio",
  41: "Mergulhador que ficou preso numa caverna submarina 6 horas e saiu convicto de ter tido uma longa conversa com alguÃ©m",
  42: "BibliotecÃ¡ria que encontrou na sua colecÃ§Ã£o livros que nÃ£o existem na ediÃ§Ã£o que tem em casa",
  43: "VeterinÃ¡ria que nota que predador e presa afectados pelo Musgo ficam lado a lado, sem conflito",
  44: "Engenheiro de som que gravou frequÃªncias no oceano afectado que sÃ³ sÃ£o audÃ­veis em sonho",
  45: "Alpinista que desceu de expediÃ§Ã£o no Ãrtico incapaz de descrever o que viu mas com os cabelos definitivamente de outra cor",
  46: "Adolescente que foi documentar o fenÃ³meno por likes e os seus vÃ­deos mostram coisas diferentes do que filmou",
  51: "Professor de filosofia prÃ©-socrÃ¡tica convicto de que Anaximandro descreveu o Musgo 2600 anos antes",
  52: "TÃ©cnico de telecomunicaÃ§Ãµes que detectou no espectro do Musgo sinais que correspondem a transmissÃµes de rÃ¡dio dos anos 40",
  53: "Escultora cega desde o nascimento que afirma que com Musgo suficiente consegue ver â€” mas nÃ£o com os olhos",
  54: "Ex-viciado que descreve o Musgo como a Ãºnica coisa que nÃ£o o faz fugir de si mesmo, mas em direcÃ§Ã£o a si",
  55: "CrianÃ§a de 7 anos incluÃ­da por insistÃªncia dos pais â€” ela diz que jÃ¡ esteve aqui antes",
  56: "Jornalista que foi cobrir a histÃ³ria, enviou um artigo devastador, e nÃ£o tem memÃ³ria de o ter escrito",
  61: "SonÃ¢mbulo cujos trajectos nocturnos formam, mapeados, os mesmos padrÃµes das manchas atlÃ¢nticas",
  62: "Economista comportamental que estuda por que Ã© que as pessoas querem ser contaminadas",
  63: "Relojoeiro que desde a exposiÃ§Ã£o ao Musgo nÃ£o consegue usar relÃ³gios â€” param todos ao mesmo tempo",
  64: "Bailarina que recuperou completamente de lesÃ£o incapacitante apÃ³s contacto com Musgo mas move-se anatomicamente de forma impossÃ­vel",
  65: "Agente enviado para vigiar a expediÃ§Ã£o que jÃ¡ nÃ£o tem a certeza de quem sÃ£o os seus superiores",
  66: "NinguÃ©m sabe quem este personagem Ã©. Ele tambÃ©m nÃ£o. A ColigaÃ§Ã£o tem os documentos mas as fotos sÃ£o de outra pessoa",
};

function rollBackground() {
  const d1 = Math.floor(Math.random() * 6) + 1;
  const d2 = Math.floor(Math.random() * 6) + 1;
  const key = d1 * 10 + d2;
  const bg = D66_BACKGROUNDS[key];
  if (bg) {
    document.getElementById('ce-background').value = bg;
    showBanner('ğŸ² D66: ' + d1 + '' + d2 + ' â€” Background atribuÃ­do', 'confirm');
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NPC SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NPC_TEMPLATES = [
  {
    id:'t1', name:'Sentinela Limiar', faction:'Limiares',
    forca:18, behavior:'Hostile',
    notes:'Fardamento tÃ¡ctico escuro. Entra em combate se o grupo tentar passar. Recua se um aliado cair. Carrega supressores de amostra biolÃ³gica no colete.'
  },
  {
    id:'t2', name:'Chefe Limiar', faction:'Limiares',
    forca:24, behavior:'Hostile',
    notes:'Negocia antes de atacar. Tem documentos classificados sobre o incidente de 2032. Acredita genuinamente que estÃ¡ a proteger a humanidade.'
  },
  {
    id:'t3', name:'TÃ©cnico Limiar', faction:'Limiares',
    forca:14, behavior:'Fearful',
    notes:'NÃ£o combate. Foge se ameaÃ§ado. Sabe onde estÃ¡ o arquivo na plataforma e pode ser convencido a colaborar.'
  },
  {
    id:'t4', name:'Agente Vector', faction:'Vectores',
    forca:16, behavior:'Friendly',
    notes:'Nunca ataca primeiro. Oferece contacto intenso com o Musgo como "presente". Tem Musgo 3 â€” os olhos tÃªm bioluminescÃªncia faint em ambientes escuros.'
  },
  {
    id:'t5', name:'Vector Recrutador', faction:'Vectores',
    forca:14, behavior:'Curious',
    notes:'Faz perguntas sobre as experiÃªncias de Musgo do grupo. Regista tudo num caderno em cÃ³digo. Parece saber coisas sobre os personagens antes de os conhecer.'
  },
  {
    id:'t6', name:'Proto-Baelfungious', faction:'Metro / Floresta',
    forca:10, behavior:'Curious',
    notes:'Pequeno, coberto de algo entre pelo e fungo. Ignora personagens com Musgo < 3. Aproxima-se de quem tem Musgo â‰¥ 3 com curiosidade. Carrega objectos sem razÃ£o aparente.'
  },
  {
    id:'t7', name:'GuardiÃ£o da Caverna (pequeno)', faction:'Caverna',
    forca:15, behavior:'Neutral',
    notes:'Foge se o personagem tiver Musgo â‰¥ 3. Ataca se provocado. Defende o espaÃ§o mas nÃ£o tem territÃ³rio fixo â€” patrulha.'
  },
  {
    id:'t8', name:'GuardiÃ£o da Caverna (grande)', faction:'Caverna',
    forca:22, behavior:'Hostile',
    notes:'NÃ£o foge. Defende territÃ³rio especÃ­fico. Para completamente se o grupo parar de se mover por 2 turnos consecutivos.'
  },
  {
    id:'t9', name:'Investigador da ColigaÃ§Ã£o', faction:'ColigaÃ§Ã£o',
    forca:13, behavior:'Neutral',
    notes:'BurocrÃ¡tico, assustado, quer que alguÃ©m lhe diga o que fazer. Tem credenciais de acesso a algumas Ã¡reas restritas. Partilha informaÃ§Ã£o em troca de protecÃ§Ã£o.'
  },
  {
    id:'t10', name:'Cientista Dissidente', faction:'ColigaÃ§Ã£o / Vectores',
    forca:12, behavior:'Friendly',
    notes:'Trabalha oficialmente para a ColigaÃ§Ã£o mas partilha dados com os Vectores. Tem teorias sobre a origem do Musgo que os seus superiores consideram perigosas. Musgo 2.'
  },
];

let localNPCs = []; // [{...npcData, uid}]

function showNPCModal(mode) {
  document.getElementById('modal-npc').classList.remove('hidden');
  document.getElementById('npc-modal-title').textContent = mode === 'template' ? 'Templates de NPC' : 'Criar NPC';

  // Populate template grid
  const grid = document.getElementById('npc-template-grid');
  grid.innerHTML = '';
  NPC_TEMPLATES.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'npc-template-btn';
    btn.innerHTML = `<div class="npc-template-name">${t.name}</div>
      <div class="npc-template-meta">${t.faction} Â· F:${t.forca} Â· ${t.behavior}</div>`;
    btn.onclick = () => fillNPCFromTemplate(t);
    grid.appendChild(btn);
  });

  // Clear custom fields
  if (mode !== 'template') {
    document.getElementById('npc-name').value    = '';
    document.getElementById('npc-faction').value = '';
    document.getElementById('npc-forca').value   = '15';
    document.getElementById('npc-behavior').value= 'Neutral';
    document.getElementById('npc-notes').value   = '';
  }
}

function fillNPCFromTemplate(t) {
  document.getElementById('npc-name').value    = t.name;
  document.getElementById('npc-faction').value = t.faction;
  document.getElementById('npc-forca').value   = t.forca;
  document.getElementById('npc-behavior').value= t.behavior;
  document.getElementById('npc-notes').value   = t.notes;
  document.getElementById('npc-modal-title').textContent = 'Confirmar NPC';
}

function hideNPCModal() {
  document.getElementById('modal-npc').classList.add('hidden');
}

function rollNPCForca() {
  const r = Array.from({length:2}, () => Math.floor(Math.random()*6)+1);
  document.getElementById('npc-forca').value = r.reduce((a,b)=>a+b,0) + 6;
}

function spawnNPC() {
  const name     = document.getElementById('npc-name').value.trim();
  const faction  = document.getElementById('npc-faction').value.trim();
  const forca    = parseInt(document.getElementById('npc-forca').value) || 15;
  const behavior = document.getElementById('npc-behavior').value;
  const notes    = document.getElementById('npc-notes').value.trim();
  if (!name) { showBanner('O NPC precisa de um nome', 'danger'); return; }
  send({ type: 'SPAWN_NPC', npc: { name, faction, forca, behavior, notes } });
  hideNPCModal();
  showBanner('ğŸ­ ' + name + ' entrou em cena', 'confirm');
}

function removeNPC(uid) {
  send({ type: 'REMOVE_NPC', uid });
}

function renderNPCList(npcs) {
  const el = document.getElementById('gm-npc-list');
  if (!el) return;
  el.innerHTML = '';
  if (!npcs || !npcs.length) {
    el.innerHTML = '<div style="color:var(--text-secondary);font-size:var(--text-xs);font-style:italic;padding:var(--sp-2)">Sem NPCs em cena.</div>';
    return;
  }
  npcs.forEach(n => {
    const card = document.createElement('div');
    const behaviorClass = { Hostile:'hostile', Friendly:'friendly', Fearful:'fearful', Curious:'curious' }[n.behavior] || '';
    card.className = 'npc-card ' + behaviorClass;
    const bLabel = { Hostile:'âš” Hostil', Friendly:'ğŸ¤ AmigÃ¡vel', Fearful:'ğŸ˜¨ Com medo', Curious:'ğŸ‘ Curioso', Neutral:'â— Neutro' }[n.behavior] || n.behavior;
    card.innerHTML = `
      <div>
        <div class="npc-name">${escHtml(n.name)}</div>
        <div class="npc-meta">${escHtml(n.faction||'')} Â· F:${n.forca} Â· ${bLabel}</div>
        ${n.notes ? `<div class="npc-notes">${escHtml(n.notes)}</div>` : ''}
      </div>
      <button class="bg-btn bg-btn-danger" style="padding:2px 6px;font-size:0.65rem;flex-shrink:0" onclick="removeNPC('${n.uid}')">âœ•</button>
    `;
    el.appendChild(card);
  });
}

function killPlayer(seat) {
  if (!confirm('Confirmar: abater jogador no seat ' + seat + '? Isto regista o evento no log da histÃ³ria.')) return;
  send({ type: 'KILL_PLAYER', seat });
  showBanner('â˜  Evento registado no log', 'danger');
}

function toggleLockTable() {
  const isLocked = gameState?.locked;
  send({ type: isLocked ? 'UNLOCK_TABLE' : 'LOCK_TABLE' });
}

function sendLocation() {
  const text = document.getElementById('gm-location-input').value.trim();
  send({ type: 'GM_SET_LOCATION', text });
  showBanner('ğŸ“ LocalizaÃ§Ã£o actualizada', 'confirm');
}

function sendScene() {
  const text = document.getElementById('gm-scene-input').value.trim();
  send({ type: 'GM_SCENE', text });
  showBanner('ğŸ“¡ Cena enviada', 'confirm');
}
function clearScene() {
  document.getElementById('gm-scene-input').value = '';
  send({ type: 'GM_SCENE', text: '' });
}

// â”€â”€ MEDIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pushMedia() {
  const mediaType = document.getElementById('gm-media-type').value;
  const data = document.getElementById('gm-media-url').value.trim();
  if (!data) { showBanner('Introduz um URL', 'danger'); return; }
  send({ type: 'GM_PUSH_MEDIA', mediaType, data });
  showBanner('ğŸ“¤ Media enviada para jogadores', 'confirm');
}
function clearMedia() {
  document.getElementById('gm-media-url').value = '';
  send({ type: 'GM_CLEAR_MEDIA' });
}

// â”€â”€ ACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendAction() {
  const text = document.getElementById('action-input').value.trim();
  send({ type: 'PLAYER_ACTION', text });
  showBanner('â†³ AcÃ§Ã£o registada', 'confirm');
}

// â”€â”€ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLog(elId, log) {
  const el = document.getElementById(elId);
  const wasBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 20;
  el.innerHTML = '';
  (log || []).forEach(entry => {
    const div = document.createElement('div');
    div.className = `log-entry ${entry.type}`;
    const time = new Date(entry.ts).toLocaleTimeString('pt-PT', {hour:'2-digit',minute:'2-digit'});
    let content = '';
    if (entry.type === 'scene') {
      content = `<div class="log-entry-content">${escHtml(entry.content)}</div>`;
    } else if (entry.type === 'dice') {
      content = `<div class="log-entry-content">${entry.playerName}: ${entry.notation} = ${entry.total} (${(entry.rolls||[]).join(', ')})</div>`;
    } else if (entry.type === 'image') {
      content = `<div class="log-entry-content"><img src="${escHtml(entry.content)}" alt="Imagem GM"></div>`;
    } else if (entry.type === 'video') {
      content = `<div class="log-entry-content">ğŸ¬ ${escHtml(entry.content)}</div>`;
    }
    div.innerHTML = `<div class="log-entry-meta">${time} Â· ${escHtml(entry.playerName||'')}</div>${content}`;
    el.appendChild(div);
  });
  if (wasBottom) el.scrollTop = el.scrollHeight;
}

function renderLogMini(elId, log) {
  const el = document.getElementById(elId);
  el.innerHTML = '';
  (log || []).slice(-10).reverse().forEach(entry => {
    const div = document.createElement('div');
    div.style.cssText = 'padding:2px 0;border-bottom:1px solid var(--bg-border);';
    const time = new Date(entry.ts).toLocaleTimeString('pt-PT', {hour:'2-digit',minute:'2-digit'});
    if (entry.type === 'scene') {
      div.innerHTML = `<span style="color:var(--text-secondary)">${time}</span> <span style="font-style:italic">${escHtml((entry.content||'').slice(0,60))}â€¦</span>`;
    } else if (entry.type === 'dice') {
      div.innerHTML = `<span style="color:var(--text-secondary)">${time}</span> <span style="color:var(--warning);font-family:var(--font-mono)">${entry.playerName}: ${entry.notation}=${entry.total}</span>`;
    } else {
      div.innerHTML = `<span style="color:var(--text-secondary)">${time} Â· ${escHtml(entry.type)}</span>`;
    }
    el.appendChild(div);
  });
}

function downloadLog() {
  if (!myLobbyId) return;
  const url = `/log?lobby=${myLobbyId}`;
  const a = document.createElement('a');
  a.href = url; a.download = `musgo-log-${myLobbyId}.json`;
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARACTER EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCharEditor() {
  // Pre-fill from current game state
  const me = gameState?.players?.find(p => p.seat === mySeat);
  const char = me?.character || {};
  document.getElementById('ce-name').value       = char.name || '';
  document.getElementById('ce-background').value = char.background || '';
  document.getElementById('ce-motivation').value = char.motivation || '';
  document.getElementById('ce-virtue').value     = char.virtue || '';
  document.getElementById('ce-fear').value       = char.fear || '';
  document.getElementById('ce-lineage').value    = char.lineage || '';
  document.getElementById('ce-forca').value      = char.forca || 22;
  document.getElementById('ce-sorte').value      = char.sorte || 5;
  document.getElementById('ce-musgo').value      = char.musgo || 0;
  document.getElementById('ce-xp').value         = char.xp || 0;
  document.getElementById('ce-skill').value      = char.skill?.d6 || 0;
  document.getElementById('ce-notes').value      = char.notes || '';
  document.getElementById('modal-char').classList.remove('hidden');
}

function hideCharEditor() {
  document.getElementById('modal-char').classList.add('hidden');
}

function saveChar() {
  const d6 = parseInt(document.getElementById('ce-skill').value) || 0;
  const char = {
    name:       document.getElementById('ce-name').value.trim(),
    background: document.getElementById('ce-background').value.trim(),
    motivation: document.getElementById('ce-motivation').value.trim(),
    virtue:     document.getElementById('ce-virtue').value.trim(),
    fear:       document.getElementById('ce-fear').value.trim(),
    lineage:    document.getElementById('ce-lineage').value.trim(),
    forca:      parseInt(document.getElementById('ce-forca').value) || 22,
    sorte:      parseInt(document.getElementById('ce-sorte').value) || 5,
    musgo:      parseInt(document.getElementById('ce-musgo').value) || 0,
    xp:         parseInt(document.getElementById('ce-xp').value) || 0,
    skill: { d6, name: SKILL_NAMES[d6]||'', effect: SKILL_FX[d6]||'' },
    notes:      document.getElementById('ce-notes').value.trim(),
  };
  send({ type: 'CHARACTER_UPDATE', character: char });
  localStorage.setItem('mm_char_' + (mySeat||0), JSON.stringify(char));
  hideCharEditor();
  showBanner('ğŸ‘¤ Personagem guardado', 'confirm');
}

function saveCharToFile() {
  const char = getCharFromEditor();
  const blob = new Blob([JSON.stringify(char, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `mundo-musgo-personagem-${char.name||'sem-nome'}.json`;
  a.click();
}

function loadCharFromFile() {
  document.getElementById('char-file-input').click();
}

function loadCharFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const char = JSON.parse(ev.target.result);
      document.getElementById('ce-name').value       = char.name || '';
      document.getElementById('ce-background').value = char.background || '';
      document.getElementById('ce-motivation').value = char.motivation || '';
      document.getElementById('ce-virtue').value     = char.virtue || '';
      document.getElementById('ce-fear').value       = char.fear || '';
      document.getElementById('ce-lineage').value    = char.lineage || '';
      document.getElementById('ce-forca').value      = char.forca || 22;
      document.getElementById('ce-sorte').value      = char.sorte || 5;
      document.getElementById('ce-musgo').value      = char.musgo || 0;
      document.getElementById('ce-xp').value         = char.xp || 0;
      document.getElementById('ce-skill').value      = char.skill?.d6 || 0;
      document.getElementById('ce-notes').value      = char.notes || '';
      showBanner('ğŸ“‚ Personagem carregado', 'confirm');
    } catch { showBanner('Ficheiro invÃ¡lido', 'danger'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function getCharFromEditor() {
  const d6 = parseInt(document.getElementById('ce-skill').value) || 0;
  return {
    name: document.getElementById('ce-name').value.trim(),
    background: document.getElementById('ce-background').value.trim(),
    motivation: document.getElementById('ce-motivation').value.trim(),
    virtue: document.getElementById('ce-virtue').value.trim(),
    fear: document.getElementById('ce-fear').value.trim(),
    lineage: document.getElementById('ce-lineage').value.trim(),
    forca: parseInt(document.getElementById('ce-forca').value)||22,
    sorte: parseInt(document.getElementById('ce-sorte').value)||5,
    musgo: parseInt(document.getElementById('ce-musgo').value)||0,
    xp:    parseInt(document.getElementById('ce-xp').value)||0,
    skill: { d6, name: SKILL_NAMES[d6]||'', effect: SKILL_FX[d6]||'' },
    notes: document.getElementById('ce-notes').value.trim(),
  };
}

function rollForca() {
  const rolls = Array.from({length:3}, () => Math.floor(Math.random()*6)+1);
  const total = rolls.reduce((a,b)=>a+b,0) + 10;
  document.getElementById('ce-forca').value = total;
  showBanner(`ğŸ² 3d6+10: ${rolls.join('+')}+10 = ${total}`, 'confirm');
}
function rollSorte() {
  const r = Math.floor(Math.random()*6)+1;
  const total = r + 2;
  document.getElementById('ce-sorte').value = total;
  showBanner(`ğŸ² 1d6+2: ${r}+2 = ${total}`, 'confirm');
}
function rollSkill() {
  const r = Math.floor(Math.random()*6)+1;
  document.getElementById('ce-skill').value = r;
  showBanner(`ğŸ² D6: ${r} â†’ ${SKILL_NAMES[r]}`, 'confirm');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RULES MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRules() { document.getElementById('modal-rules').classList.remove('hidden'); }
function hideRules() { document.getElementById('modal-rules').classList.add('hidden'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function extractYoutubeId(url) {
  const m = url.match(/(?:youtu\.be\/|[?&]v=)([A-Za-z0-9_-]{11})/);
  return m ? m[1] : null;
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    hideRules(); hideCharEditor(); hideVoice();
  }
  // Enter to send chat
  if (e.key === 'Enter' && !e.shiftKey) {
    const ac = document.activeElement;
    if (ac?.id === 'gm-chat-input')     { sendChat('gm');     return; }
    if (ac?.id === 'player-chat-input') { sendChat('player'); return; }
  }
});

// Close modals on overlay click
['modal-char','modal-rules','modal-npc'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target === e.currentTarget)
      e.currentTarget.classList.add('hidden');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAME SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-confirm-name').addEventListener('click', () => {
  const name = document.getElementById('input-name').value.trim().slice(0, 24);
  if (!name) return;
  myName = name;
  renderLobbyList(cachedLobbies);
  send({ type: 'LOBBIES' });
});
document.getElementById('input-name').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('btn-confirm-name').click();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
showScreen('screen-name');
connect();
</script>
</body>
</html>
